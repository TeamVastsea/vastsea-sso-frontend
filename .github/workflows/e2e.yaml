name: End to End test

on:
  pull_request:
  workflow_dispatch:

env:
  CI: true
  DATABASE_URL: file:dev.db
  SWAGGER_TITLE: Vastsea SSO
  SWAGGER_DESC: 一站式认证、鉴权服务
  VERSION: 1.0.0-alpha
  COMMON_ERROR_REDIRECT: http://localhost:3000/auth/error
  CLIENT_ID: AuthServer
  CLIENT_SECRET: AuthServer
  REDIRECT: http://localhost:3000/auth/redirect

jobs:
  Test:
    runs-on: ubuntu-latest
    container: node:20-bookworm-slim

    services:
      redis:
        image: redis
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 23
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm i
      - name: e2e testing
        working-directory: packages/backend
        run:
             rm -rf prisma/migrations && mv prisma/dev_migrations prisma/migrations &&
             pnpm prisma migrate deploy --schema=prisma/schema.dev.prisma &&
             pnpm prisma migrate reset -f --schema=prisma/schema.dev.prisma && pnpm test:e2e client &&
             pnpm prisma migrate reset -f --schema=prisma/schema.dev.prisma && pnpm test:e2e role && 
             pnpm prisma migrate reset -f --schema=prisma/schema.dev.prisma && pnpm test:e2e auth && 
             pnpm prisma migrate reset -f --schema=prisma/schema.dev.prisma && pnpm test:e2e account